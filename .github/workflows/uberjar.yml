name: Build Uberjar

on:
  workflow_call:
    inputs:
      commit:
        description: "Optional full-length commit SHA-1 hash"
        type: string
        required: false
    outputs:
      artifact_name_oss:
        description: "Name of the OSS uberjar artifact"
        value: ${{ jobs.build.outputs.artifact_name_oss }}
      artifact_name_ee:
        description: "Name of the EE uberjar artifact"
        value: ${{ jobs.build.outputs.artifact_name_ee }}

jobs:
  build:
    name: Build MB ${{ matrix.edition }}
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    strategy:
      matrix:
        edition: [ee, oss]
    env:
      MB_EDITION: ${{ matrix.edition }}
      INTERACTIVE: false
    outputs:
      artifact_name_oss: ${{ steps.set_artifact_names.outputs.artifact_name_oss }}
      artifact_name_ee: ${{ steps.set_artifact_names.outputs.artifact_name_ee }}
    steps:
      - name: Check out the code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit }}
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
        with:
          m2-cache-key: uberjar
          java-version: 21
      - name: Build
        run: ./bin/build.sh
      - name: Set artifact names
        id: set_artifact_names
        run: |
          SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          echo "artifact_name_oss=metabase-oss-${SHA}-uberjar" >> $GITHUB_OUTPUT
          echo "artifact_name_ee=metabase-ee-${SHA}-uberjar" >> $GITHUB_OUTPUT
      - name: Prepare uberjar artifact
        uses: ./.github/actions/prepare-uberjar-artifact
        with:
          name: metabase-${{ matrix.edition }}-${{ github.event.pull_request.head.sha || github.sha }}-uberjar

  check_jar_health:
    runs-on: ubuntu-22.04
    name: Is ${{ matrix.edition }} (java ${{ matrix.java-version }}) healthy?
    needs: build
    timeout-minutes: 10
    strategy:
      matrix:
        edition: [ee, oss]
        java-version: [21]
    steps:
      - name: Prepare JRE (Java Run-time Environment)
        uses: actions/setup-java@v4
        with:
          java-package: jre
          java-version: ${{ matrix.java-version }}
          distribution: "temurin"
      - run: java -version
      - uses: actions/download-artifact@v4
        name: Retrieve uberjar artifact
        with:
          name: metabase-${{ matrix.edition }}-${{ github.event.pull_request.head.sha || github.sha }}-uberjar
      - name: Launch uberjar
        run: >-
          java --add-opens java.base/java.nio=ALL-UNNAMED -jar ./target/uberjar/metabase.jar &
      - name: Wait for Metabase to start
        run: while ! curl 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do sleep 1; done
